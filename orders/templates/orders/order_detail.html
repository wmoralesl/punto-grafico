{% extends "private/base.html" %}

{% block content %}
<div class="container-xl py-4">
    
    <a href="{% url 'orders:list' %}" class="btn btn-secondary mb-4">
        ← Regresar
    </a>

    <div id="app">
        
        <!-- Cargando -->
        <div v-if="loading" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>

        <!-- Contenido principal -->
        <div v-else>

            <!-- Encabezado del Pedido -->
            <div class="c mb-4">
                <h2 class="text-center">Pedido # [[ order.id ]]</h2>
                <div class="card p-2">
                    <div class="row text-center">
                        <div class="col mt-2">
                            <p><strong>Cliente:</strong> [[ order.client_info.name ]]</p>
                        </div>
                        <div class="col mt-2">
                            <p><strong>Teléfono:</strong> [[ order.client_info.phone ]]</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalles del Pedido -->
            <h4 class="text-center mb-3">Detalles del Pedido</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle text-end shadow-sm">
                    <thead class="table-secondary text-center">
                        <tr>
                            <th class="text-start">Cantidad</th>
                            <th class="text-start">Descripción</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="line in order.lines" :key="line.id">
                            <td class="text-start">[[ line.quantity ]]</td>
                            <td class="text-start">[[ line.description ]]</td>
                            <td>Q [[ line.unit_price ]]</td>
                            <td>Q [[ (line.quantity * line.unit_price).toFixed(2) ]]</td>
                        </tr>
                    </tbody>
                    <tfoot class="fw-bold">
                        <tr class="table-light">
                            <td colspan="3" class="text-end">Total</td>
                            <td>Q [[ order.total ]]</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end">Anticipo</td>
                            <td>Q [[ order.anticipo ]]</td>
                        </tr>
                        <tr class="table-warning">
                            <td colspan="3" class="text-end">Saldo Pendiente</td>
                            <td>Q [[ (order.total - order.anticipo).toFixed(2) ]]</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Información adicional -->
            <div class="row text-center mt-4">
                <div class="col-md-4 mb-2">
                    <div class="card p-2">
                        <strong>Fecha Solicitada</strong>
                        <p class="mb-0">[[ order.request_date ]]</p>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="card p-2">
                        <strong>Fecha Entrega</strong>
                        <p class="mb-0">[[ order.deadline ]]</p>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="card p-2">
                        <strong>Encargado</strong>
                        <p class="mb-0">[[ order.responsible_info.name ]]</p>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-2">
                <a href="#" class="btn btn-primary">Imprimir</a>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const order = ref({});
            const loading = ref(true);

            const fetchOrder = async () => {
                try {
                    const orderId = window.location.pathname.split('/').pop();
                    const response = await axios.get(`http://localhost:8000/admin/o/api/orders/{{object.id}}/`);
                    order.value = response.data;
                } catch (error) {
                    console.error('Error fetching order:', error);
                } finally {
                    loading.value = false;
                }
            };

            onMounted(() => {
                fetchOrder();
            });

            return {
                order,
                loading
            };
        }
    }).mount('#app');
</script>
{% endblock %}
